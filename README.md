# Gestion des Ouvriers Occasionnels

**Administrative Management System & Official Document Generation**

A desktop application for managing occasional workers, tracking their presence, and automatically generating official administrative documents.

## Features

- **Worker Management**: Add, view, search, and delete workers with automatic salary assignment
- **Presence Tracking**: Monthly calendar-based presence tracking with automatic calculations
- **Document Generation**: Automatic generation of monthly and quarterly official documents

## Technical Stack

- **Desktop Framework**: Electron.js
- **Backend**: Node.js
- **Database**: SQLite (local)
- **Frontend**: HTML, CSS, JavaScript
- **Document Generation (DOCX-only)**: Python backend (python-docx)

## Installation

```bash
# Install dependencies
npm install

# Run in development mode (opens DevTools)
npm run dev

# Run normally
npm start

# Build for production
npm run build
```

### Python backend (build machine only)

All documents are generated by Python code:
- `src/python/generate_role.py` (Role des Journées: exact scanned-template layout)
- `src/python/generate_document.py` (other documents)

For packaging, this project builds a standalone backend bundle with PyInstaller (`onedir` mode).
Target PCs do not need Python/pip/venv.

Install backend build dependencies on the build machine:

```bash
python -m pip install -r backend/requirements.txt
```

The build script uses module execution (no global `pyinstaller` binary required):

`python -m PyInstaller ...`

### Packaging (Windows) - includes Python backend

Backend output is built and copied as:

`dist/mybackend/* -> resources/bin/mybackend/*`

When packaged, Electron uses:

`path.join(process.resourcesPath, "bin", "mybackend", "mybackend.exe")`

Installer defaults are configured for per-user install (no admin rights required).

Build commands:

```bash
# 1) build standalone backend exe (PyInstaller) + copy to resources/bin
npm run build:all

# 2) package Windows installer
npm run dist
```

Individual helper commands:

```bash
# Build backend bundle (dist/mybackend/)
npm run build:py

# Copy dist/mybackend/ -> resources/bin/mybackend/
npm run copy:py
```

In dev mode, Electron resolves backend path from:
- `resources/bin/mybackend/mybackend.exe` (preferred)
- `dist/mybackend/mybackend.exe` (fallback)
- onefile legacy fallback (`mybackend.exe`) is still supported

Backend spawn behavior:
- runs with `cwd = dirname(executablePath)` to avoid relative-path issues
- appends backend stderr to:
  - `path.join(app.getPath("userData"), "backend.log")`
- performs a readiness wait (`--ping`) with retries before UI startup

### Windows builds from Arch

Use GitHub Actions for reliable Windows artifacts (backend EXE + installer) from Arch Linux.

- Workflow: `.github/workflows/windows-release.yml`
- Triggers:
  - push to `main`
  - manual `workflow_dispatch`
- Runner: `windows-latest`
- Build flow on CI:
  1. `npm ci`
  2. `python -m pip install -r backend/requirements.txt`
  3. `npm run build:py`
  4. `npm run copy:py`
  5. `npm run dist`

Artifacts uploaded by CI:
- `windows-installer` (NSIS/installer outputs from `dist/`)
- `windows-unpacked` (if `dist/win-unpacked` exists)

From Arch for local development (no Windows packaging):

```bash
npm ci
npm run dev
```

How to download Windows artifacts:
1. Open your GitHub repository `Actions` tab.
2. Open the latest `Windows Release` run.
3. Download artifacts from the run summary (`windows-installer`, `windows-unpacked`).

### Windows builds from Linux (Docker + Wine)

You can also build Windows artifacts from Linux using Docker:

- Dockerfile: `build/windows/Dockerfile`
- Build script in container: `build/windows/build-win.sh`
- Workflow: `.github/workflows/windows-docker.yml`

Local usage:

```bash
docker build -t gov-win-builder -f build/windows/Dockerfile .
docker run --rm -v "$PWD:/workspace" -w /workspace gov-win-builder bash -lc "./build/windows/build-win.sh"
```

Hard guard before Windows packaging:
- `npm run build:win` now runs `npm run check:win-backend` first.
- It fails if `resources/bin/mybackend/mybackend.exe` is missing or not a Windows PE binary.
- This prevents accidental release with Linux ELF backend payload.

### Troubleshooting

- Backend executable missing at runtime:
  - Run `npm run build:all` before packaging.
  - Verify installer contains `resources/bin/mybackend/` through `extraResources`.
- Hidden imports (PyInstaller):
  - Add `--hidden-import your.module` in `scripts/build-python-backend.js` (`python -m PyInstaller --hidden-import ...`).
  - Or set env var for extra modules: `PYI_HIDDEN_IMPORTS=mod1,mod2 npm run build:py`.
  - For non-Python assets, use `PYI_ADD_DATA`:
    - Linux/macOS example: `PYI_ADD_DATA=src/python/templates=src/python/templates npm run build:py`
    - Windows CI uses `;` internally for `--add-data` entries.
  - For complex cases, use a `.spec` file/hook approach (`hiddenimports`, `collect_submodules`).
- Missing DLL / binary dependency errors:
  - Reinstall backend deps on build machine: `python -m pip install -r backend/requirements.txt`.
  - Rebuild the executable: `npm run build:py`.
  - Ensure backend and Electron build target are both Windows x64.
  - If user PCs show `VCRUNTIME*.dll` or `MSVCP*.dll` errors, inspect `backend.log` first, then add VC++ redistributable strategy in installer.
- `better_sqlite3.node: invalid ELF header`: `node_modules` was installed on a different OS/CPU. Re-run `npm install` (or `npm run postinstall`) on the current machine to rebuild native dependencies.

## Project Structure

```
gestion-ouvriers-occasionnels/
├── backend/
│   ├── main.py                # PyInstaller entrypoint (bundled backend exe)
│   └── requirements.txt       # Backend build dependencies
├── resources/
│   └── bin/                   # Bundled backend executable for Electron
├── src/
│   ├── main.js                 # Electron main process
│   ├── preload.js              # Preload script for IPC
│   ├── database/
│   │   ├── init.js             # Database initialization
│   │   └── schema.sql          # Database schema
│   ├── backend/
│   │   ├── workers.js          # Workers CRUD operations
│   │   ├── presence.js         # Presence management
│   │   └── constants.js        # Business constants
│   ├── documents/
│   │   └── monthly/            # JS wrapper(s) that call Python
│   ├── python/
│   │   ├── generate_role.py    # Role des Journées (DOCX)
│   │   └── generate_document.py# Other documents (DOCX)
│   └── frontend/
│       ├── index.html          # Main application page
│       ├── css/
│       │   └── styles.css      # Application styles
│       └── js/
│           ├── workers.js      # Workers page logic
│           ├── presence.js     # Presence page logic
│           └── documents.js    # Documents page logic
├── package.json
├── runtime/                   # Bundled Python runtime (optional)
├── scripts/
│   ├── build-python-backend.js
│   └── copy-python-backend.js
└── README.md
```

## Worker Types

- **OS** (Ouvrier Spécialisé): 100.40 DH/day
- **ONS** (Ouvrier Non Spécialisé): 93.00 DH/day

## Documents

### Monthly Documents (7)
1. Dépense en Régie – Salaire du personnel occasionnel
2. Reçu numéro mois/année (Total)
3. Demande d'autorisation de paiement
4. Certificat de paiement
5. Ordre de paiement
6. Mandat de paiement
7. Bordereau

### Quarterly Documents (2)
1. État de versement RCAR – Cotisation salariale
2. État de versement RCAR – Cotisation patronale

## License

MIT
